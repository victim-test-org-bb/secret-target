name: GITHUB_TOKEN Scope Probe
on:
  workflow_dispatch:
permissions:
  contents: read
  actions: read
  packages: read
  issues: read
  pull-requests: read
jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Token info
        run: |
          echo "=== Token headers ==="
          curl -sI -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }} | grep -i "x-oauth-scopes"
          
          echo ""
          echo "=== Can access other repos in same org? ==="
          # List org repos
          curl -s -w "
HTTP:%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/victim-test-org-bb/repos" | tail -3
          
          echo ""
          echo "=== Can access org secrets? ==="
          curl -s -w "
HTTP:%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/victim-test-org-bb/actions/secrets" | tail -3
          
          echo ""
          echo "=== Can access other repo contents? ==="
          curl -s -w "
HTTP:%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/s2ongmo/actions-bypass-test/contents/" | tail -3
          
          echo ""
          echo "=== Can create dispatch in other repo? ==="
          curl -s -w "
HTTP:%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/s2ongmo/actions-bypass-test/dispatches" \
            -d "{\"event_type\":\"test\"}" | tail -3
          
          echo ""
          echo "=== Can list own repo environment secrets? ==="
          curl -s -w "
HTTP:%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/environments/secure-prod/secrets" | tail -3
          
          echo ""
          echo "=== Can read deployment logs from other workflows? ==="
          curl -s -w "
HTTP:%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | \
            python3 -c "import sys,json; d=json.load(sys.stdin); print(f'total={d.get(\"total_count\",0)}, first_status={d.get(\"workflow_runs\",[{}])[0].get(\"status\",\"?\") if d.get(\"workflow_runs\") else \"none\"}')  " 2>/dev/null || echo "parse error"
          
          echo ""
          echo "=== GraphQL: Can query other repos? ==="
          curl -s -w "
HTTP:%{http_code}" -X POST \
            -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/graphql" \
            -d "{\"query\":\"{repository(owner:\\"s2ongmo\\",name:\\"actions-bypass-test\\"){name,isPrivate}}\"}" | tail -3
          
          echo ""
          echo "=== GITHUB_TOKEN JWT claims ==="
          echo "${{ secrets.GITHUB_TOKEN }}" | cut -d. -f2 | base64 -d 2>/dev/null | python3 -m json.tool 2>/dev/null || echo "Not a JWT or parse failed"
